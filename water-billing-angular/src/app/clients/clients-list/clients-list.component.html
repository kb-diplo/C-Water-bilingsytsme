<div class="container-fluid">
  <div class="d-sm-flex align-items-center justify-content-between mb-4" *ngIf="isAdmin(); else clientView">
    <h1 class="h3 mb-0 text-gray-800">Client Management</h1>
    <div class="d-flex gap-2">
      <button class="btn btn-primary btn-sm shadow-sm" (click)="openAddModal()">
        Add Client
      </button>
      <button class="btn btn-success btn-sm shadow-sm" (click)="exportExcel()">
        <i class="fas fa-file-excel fa-sm text-white-50"></i> Download Excel
      </button>
    </div>
  </div>
  
  <ng-template #clientView>
    <div class="text-center">
      <h1 class="h3 mb-2 text-primary font-weight-bolder">Clients Information</h1>
    </div>
  </ng-template>

  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Clients Information</h6>
      <div class="col-md-4">
        <div class="input-group">
          <input 
            type="text" 
            class="form-control" 
            placeholder="Search clients..." 
            [(ngModel)]="searchTerm"
            (input)="onSearch()">
          <div class="input-group-append">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive" *ngIf="!loading">
        <table class="table table-hover table-striped" width="100%" cellspacing="0">
          <thead class="bg-primary text-white">
            <tr>
              <th class="border-0 py-3">Meter #</th>
              <th class="border-0 py-3">Full Name</th>
              <th class="border-0 py-3">Email</th>
              <th class="border-0 py-3">Contact</th>
              <th class="border-0 py-3">Location</th>
              <th class="border-0 py-3">Status</th>
              <th class="border-0 py-3 text-center" *ngIf="isAdmin() || isMeterReader()">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let client of filteredClients" class="align-middle">
              <td class="py-3">
                <span class="badge badge-light font-weight-bold">{{ client.meterNumber || '-' }}</span>
              </td>
              <td class="py-3">
                <div class="font-weight-bold text-dark">{{ getFullName(client) }}</div>
                <small class="text-muted">ID: {{ client.id }}</small>
              </td>
              <td class="py-3">
                <span class="text-dark">{{ client.email || '-' }}</span>
              </td>
              <td class="py-3">
                <span class="font-weight-medium text-dark">{{ client.phone || client.contactNumber || '-' }}</span>
              </td>
              <td class="py-3">
                <span class="text-muted">{{ client.location || client.address || '-' }}</span>
              </td>
              <td class="py-3">
                <span class="badge badge-pill px-3 py-2" 
                      [class.badge-success]="client.connectionStatus === 'Connected' || client.status === 'Active'"
                      [class.badge-warning]="client.connectionStatus === 'Pending'"
                      [class.badge-danger]="client.connectionStatus === 'Disconnected' || client.status === 'Inactive'">
                  <i class="fas fa-circle mr-1" style="font-size: 8px;"></i>
                  {{ client.connectionStatus || client.status || 'Unknown' }}
                </span>
              </td>
              <td class="text-center py-3" *ngIf="isAdmin() || isMeterReader()">
                <div class="btn-group btn-group-sm" role="group">
                  <!-- Admin buttons -->
                  <button class="btn btn-primary btn-sm" 
                          (click)="editClient(client)"
                          title="Edit Client"
                          *ngIf="isAdmin()">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-info btn-sm" 
                          (click)="viewClient(client)"
                          title="View Details">
                    <i class="fas fa-eye"></i>
                  </button>
                  <!-- Add Reading button for both Admin and MeterReader -->
                  <button class="btn btn-success btn-sm" 
                          (click)="addReading(client)"
                          title="Add Meter Reading">
                    <i class="fas fa-tachometer-alt"></i>
                  </button>
                  <!-- Delete button only for Admin -->
                  <button class="btn btn-danger btn-sm" 
                          (click)="deleteClient(client)"
                          title="Delete Client"
                          *ngIf="isAdmin()">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredClients.length === 0">
              <td [attr.colspan]="(isAdmin() || isMeterReader()) ? 7 : 6" class="text-center py-4">
                <div class="text-muted">
                  <i class="fas fa-users fa-2x mb-2"></i>
                  <p class="mb-0">No clients found</p>
                  <small>Try adjusting your search criteria</small>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="text-center py-4" *ngIf="loading">
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" [class.show]="showAddModal" [style.display]="showAddModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" *ngIf="isAdmin()">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">{{ isEditMode ? 'Edit Client' : 'Add New Client' }}</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeAddModal()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="clientForm" (ngSubmit)="onSubmit()">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Username *</label>
                <input type="text" class="form-control" formControlName="username" required 
                       placeholder="Enter username for login">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Meter Number *</label>
                <input type="text" class="form-control" formControlName="meterNumber" required>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>First Name *</label>
                <input type="text" class="form-control" formControlName="firstName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Last Name *</label>
                <input type="text" class="form-control" formControlName="lastName" required>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Middle Name</label>
                <input type="text" class="form-control" formControlName="middleName">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Email *</label>
                <input type="email" class="form-control" formControlName="email" required>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Contact Number *</label>
                <input type="text" class="form-control" formControlName="contactNumber" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Address *</label>
                <textarea class="form-control" formControlName="address" rows="2" required></textarea>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4" *ngIf="!isEditMode">
              <div class="form-group">
                <label>Password *</label>
                <input type="password" class="form-control" formControlName="password" required>
              </div>
            </div>
            <div class="col-md-4" *ngIf="!isEditMode">
              <div class="form-group">
                <label>Confirm Password *</label>
                <input type="password" class="form-control" formControlName="confirmPassword" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>Connection Status *</label>
                <select class="form-control" formControlName="status" required>
                  <option value="Connected">Connected</option>
                  <option value="Disconnected">Disconnected</option>
                  <option value="Pending">Pending</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" [disabled]="isEditMode ? false : clientForm.invalid">
              <i class="fas" [class.fa-user-plus]="!isEditMode" [class.fa-save]="isEditMode" class="mr-1"></i> 
              {{ isEditMode ? 'Update Client' : 'Add Client' }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="closeAddModal()">
              <i class="fas fa-times mr-1"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade" [class.show]="showAddModal" *ngIf="showAddModal"></div>

<!-- Add Reading Modal -->
<div class="modal fade" [class.show]="showReadingModal" [style.display]="showReadingModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" *ngIf="showReadingModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Add Meter Reading</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeReadingModal()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedClient" class="mb-3">
          <h6>Client Information:</h6>
          <p><strong>Name:</strong> {{ selectedClient.fullName }}</p>
          <p><strong>Meter Number:</strong> {{ selectedClient.meterNumber }}</p>
          <p><strong>Location:</strong> {{ selectedClient.location }}</p>
        </div>

        <!-- Previous Reading Information -->
        <div *ngIf="previousReading !== null" class="alert alert-info mb-3">
          <h6><i class="fas fa-info-circle"></i> Previous Reading Information</h6>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>Previous Reading:</strong> {{ previousReading | number:'1.2-2' }} m³</p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><strong>Date:</strong> {{ previousReadingDate | date:'short' }}</p>
            </div>
          </div>
          <small class="text-muted">New reading must be greater than {{ previousReading | number:'1.2-2' }} m³</small>
        </div>

        <div *ngIf="previousReading === null" class="alert alert-warning mb-3">
          <h6><i class="fas fa-exclamation-triangle"></i> First Reading</h6>
          <p class="mb-0">This is the first reading for this meter. Please enter the current meter reading.</p>
        </div>
        
        <form [formGroup]="readingForm" (ngSubmit)="onSubmitReading()">
          <div class="form-group mb-3">
            <label for="currentReading">Current Reading (m³) *</label>
            <input type="number" 
                   id="currentReading"
                   formControlName="currentReading" 
                   class="form-control"
                   [class.is-invalid]="readingForm.get('currentReading')?.invalid && readingForm.get('currentReading')?.touched"
                   placeholder="Enter current meter reading" 
                   step="0.01"
                   [min]="previousReading || 0.01">
            <div class="invalid-feedback" *ngIf="readingForm.get('currentReading')?.invalid && readingForm.get('currentReading')?.touched">
              <div *ngIf="readingForm.get('currentReading')?.errors?.['required']">Current reading is required</div>
              <div *ngIf="readingForm.get('currentReading')?.errors?.['min']">
                Reading must be greater than {{ previousReading ? (previousReading | number:'1.2-2') : '0' }} m³
              </div>
            </div>
            <small class="form-text text-muted">
              Enter the current meter reading in cubic meters (m³)
              <span *ngIf="previousReading"> - Must be greater than previous reading of {{ previousReading | number:'1.2-2' }} m³</span>
            </small>
          </div>

          <!-- Units Calculation Preview -->
          <div *ngIf="readingForm.get('currentReading')?.value && previousReading !== null" class="alert alert-success">
            <h6><i class="fas fa-calculator"></i> Calculation Preview</h6>
            <p class="mb-1">
              <strong>Units Used:</strong> 
              {{ (readingForm.get('currentReading')?.value - previousReading) | number:'1.2-2' }} m³
            </p>
            <small class="text-muted">
              {{ readingForm.get('currentReading')?.value | number:'1.2-2' }} - {{ previousReading | number:'1.2-2' }} = 
              {{ (readingForm.get('currentReading')?.value - previousReading) | number:'1.2-2' }} m³
            </small>
          </div>
        </form>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeReadingModal()" [disabled]="readingLoading">Cancel</button>
          <button type="button" class="btn btn-success" (click)="onSubmitReading()" [disabled]="readingForm.invalid || readingLoading">
            <span *ngIf="readingLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
            <i *ngIf="!readingLoading" class="fas fa-tachometer-alt me-1"></i> 
            {{ readingLoading ? 'Adding Reading...' : 'Add Reading' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reading Modal backdrop -->
<div class="modal-backdrop fade" [class.show]="showReadingModal" *ngIf="showReadingModal"></div>
